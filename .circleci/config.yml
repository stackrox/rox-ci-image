defaults: &defaults
  docker:
    - image: cimg/base:stable

version: 2.1

orbs:
  bats: circleci/bats@1.0.0

parameters:
  base_ubuntu_tag:
    type: string
    default: "20.04"

commands:
  open-test-pr:
    parameters:
      repo:
        description: Name of the repo where the PR should be opened.
        type: string
      image-flavors:
        description: The flavors of the apollo-ci image that the target repo uses. A comma separated list.
        type: string
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints:
            - "c7:dd:37:f0:33:4b:a1:16:80:d6:56:48:fd:d3:6c:87"
      - run:
          name: Clone << parameters.repo >> repo
          command: |
            git clone git@github.com:stackrox/<< parameters.repo >>.git /tmp/<< parameters.repo >>
      - run:
          name: Create a commit in << parameters.repo >> that updates dependent images if necessary
          command: |
            if ! .circleci/changes_affect.sh << parameters.repo >>; then
              echo "No need to open/update a PR against << parameters.repo >> - current changes are not affecting this repo."
              exit 0;
            fi

            pushd "/tmp/<< parameters.repo >>"

            git config user.email "roxbot@stackrox.com"
            git config user.name "RoxBot"
            branch_name="roxbot/update-ci-image-from-${CIRCLE_PULL_REQUEST##*/}"
            if git fetch --quiet origin "${branch_name}"; then
              git checkout "${branch_name}"
              git pull --quiet --set-upstream origin "${branch_name}"
            else
              git checkout -b "${branch_name}"
              # The first commit is created to allow opening a PR and setting all required labels before we trigger the CI
              git commit --allow-empty -am "Noop commit [ci skip]"
              git push --set-upstream origin "${branch_name}"
            fi

            todo="# TODO(do not merge): After upstream PR is merged, cut a tag and update this"

            IFS=',' read -r -a flavors \<<<"<< parameters.image-flavors >>"
            for flavor in "${flavors[@]}"; do
              echo "Doing image substitutions for $flavor"
              prefix="$flavor-"
              if [[ "$flavor" == "rox" ]]; then
                prefix=""
              fi
              popd
              tag="$(.circleci/get_tag.sh "$flavor")"
              pushd "/tmp/<< parameters.repo >>"

              sed -r -i "s@(.*)/apollo-ci:${prefix}[0-9].*@\1/apollo-ci:${tag} ${todo}@g" .circleci/config.yml

              # If the image parameter was originally quoted, we need to close the quote
              sed -r -i "s@\"(.*)/apollo-ci:${tag} # TODO@\"\1/apollo-ci:${tag}\" # TODO@g" .circleci/config.yml

              if [[ "$flavor" == "stackrox-build" ]] && [[ "<< parameters.repo >>" == "stackrox" ]]; then
                echo "${tag} ${todo}" > BUILD_IMAGE_VERSION
              fi

              if git diff-index --quiet HEAD; then
                echo "There are no changes to commit in the dependent repo"
              else
                git commit -am "Bump apollo-ci:$flavor image tag to ${tag##:}"
              fi
            done

            git push origin "${branch_name}"
            popd

            # Open or update a PR and configure labels, assignees
            .circleci/create_update_pr.sh \
              "${branch_name}" \
              "<< parameters.repo >>" \
              "Update apollo-ci image" \
              "Bump version of apollo-ci image used in CircleCI" \
              "ci-upgrade-tests"

  build-and-push-image:
    parameters:
      image-flavor:
        description: A flavor used to tag the apollo-ci image.
        type: string
      dockerfile-path:
        description: Path to the Dockerfile
        type: string
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.7
      - run:
          name: Build & push image
          command: |
            # Login may be required for pulling the base image for building (if used) and to omit the rate limit
            docker login -u "$DOCKER_IO_PULL_USERNAME" -p "$DOCKER_IO_PULL_PASSWORD" docker.io
            docker login -u "$QUAY_RHACS_ENG_RW_USERNAME" -p "$QUAY_RHACS_ENG_RW_PASSWORD" quay.io

            BASE_TAG="$(.circleci/get_tag.sh base)"
            BUILD_ARGS=(--build-arg "BASE_TAG=$BASE_TAG")
            BUILD_ARGS+=(--build-arg "BASE_UBUNTU_TAG=<< pipeline.parameters.base_ubuntu_tag >>")

            rocksdb_sha="$(git hash-object images/rocksdb.Dockerfile)"
            BUILD_ARGS+=(--build-arg "ROCKSDB_TAG=rocksdb-<< pipeline.parameters.base_ubuntu_tag >>-${rocksdb_sha}")

            centos8_rocksdb_sha="$(git hash-object images/centos8-rocksdb.Dockerfile)"
            BUILD_ARGS+=(--build-arg "CENTOS8_ROCKSDB_TAG=centos8-rocksdb-${centos8_rocksdb_sha}")

            TAG="$(.circleci/get_tag.sh "<< parameters.image-flavor >>")"
            IMAGE="quay.io/rhacs-eng/apollo-ci:${TAG}"

            if [[ "<< parameters.image-flavor >>" == "centos8-rocksdb" ]] && \
                   DOCKER_CLI_EXPERIMENTAL=enabled docker manifest inspect "$IMAGE" >/dev/null; then
              echo "Image '$IMAGE' already exists - no need to build it"
              circleci step halt
              exit 0
            fi

            docker build \
              "${BUILD_ARGS[@]}" \
              -f << parameters.dockerfile-path >> \
              -t "${IMAGE}" \
              images/

            for i in {1..5}; do
              docker push "quay.io/rhacs-eng/apollo-ci:${TAG}" && break || sleep 15
            done

  check-image:
    parameters:
      image-flavor:
        description: The flavor of apollo-ci image to check.
        type: string
    steps:
      - run:
          name: Get roxctl
          command: |
            curl -k -H "Authorization: Bearer $ROX_API_TOKEN" https://$STACKROX_CENTRAL_HOST:443/api/cli/download/roxctl-linux -o roxctl
            chmod +x ./roxctl
      - run:
          name: Scan images for policy deviations and vulnerabilities
          command: |
            TAG="$(.circleci/get_tag.sh "<< parameters.image-flavor >>")"
            ./roxctl image check --endpoint "$STACKROX_CENTRAL_HOST:443" --image "quay.io/rhacs-eng/apollo-ci:${TAG}"

jobs:
  build-and-push-base:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/base.Dockerfile
          image-flavor: "base"

  # We separate  building of rocksdb to save CI time (~15 minutes).
  # See rocksdb.Dockerfile for more information.
  build-and-push-rocksdb:
    <<: *defaults
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: "Ensure that rocksdb container is up-to-date"
          command: |
            docker login -u "$DOCKER_IO_PULL_USERNAME" -p "$DOCKER_IO_PULL_PASSWORD" docker.io
            docker login -u "$QUAY_RHACS_ENG_RW_USERNAME" -p "$QUAY_RHACS_ENG_RW_PASSWORD" quay.io

            IMAGE="quay.io/rhacs-eng/apollo-ci:rocksdb-<< pipeline.parameters.base_ubuntu_tag >>-$(git hash-object images/rocksdb.Dockerfile)"
            if DOCKER_CLI_EXPERIMENTAL=enabled docker manifest inspect "$IMAGE" >/dev/null; then
              echo "Image '$IMAGE' already exists - no need to build"
            else
              echo "Image '$IMAGE' not found - building and pushing it..."
              docker build \
                --build-arg "BASE_UBUNTU_TAG=<< pipeline.parameters.base_ubuntu_tag >>" \
                -f images/rocksdb.Dockerfile \
                -t "$IMAGE" \
                images/
              docker push "$IMAGE" | cat
            fi

  build-and-push-rox:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/rox.Dockerfile
          image-flavor: "rox"
      - check-image:
          image-flavor: "rox"

  build-and-push-centos8-rocksdb:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/centos8-rocksdb.Dockerfile
          image-flavor: "centos8-rocksdb"

  build-and-push-stackrox-build:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/stackrox-build.Dockerfile
          image-flavor: "stackrox-build"
      - check-image:
          image-flavor: "stackrox-build"

  test-cci-export:
    <<: *defaults
    resource_class: medium
    steps:
    - checkout
    - setup_remote_docker
    - run:
        name: Test cci-export inside Docker
        command: |
          docker login -u "$QUAY_RHACS_ENG_RO_USERNAME" --password-stdin \<<<"$QUAY_RHACS_ENG_RO_PASSWORD" quay.io
          BASE_TAG="$(.circleci/get_tag.sh base)"

          docker build \
            --build-arg BASE_TAG="$BASE_TAG" \
            -f images/test.cci-export.Dockerfile \
            -t test.cci-export \
            images/
          docker run --rm test.cci-export

  build-and-push-env-check:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/env-check.Dockerfile
          image-flavor: "env-check"
      - check-image:
          image-flavor: "env-check"

  unit-test-env-check:
    machine:
      image: ubuntu-2004:202111-01
    resource_class: medium
    steps:
      - checkout
      - run:
          name: Login to quay.io
          command: |
            docker login -u "$QUAY_RHACS_ENG_RO_USERNAME" --password-stdin \<<<"$QUAY_RHACS_ENG_RO_PASSWORD" quay.io

      - run:
          name: Run unit tests for circleci-tools using the built image
          command: |
            TAG="$(.circleci/get_tag.sh "env-check")"
            export IMAGE="quay.io/rhacs-eng/apollo-ci:${TAG}"
            docker pull "$IMAGE"
            images/circleci-tools/test/test.bats

  check-env-for-sensitive-values:
    machine:
      image: ubuntu-2004:202111-01
    resource_class: medium
    steps:
      - checkout
      - run:
          name: Login to quay.io
          command: |
            docker login -u "$QUAY_RHACS_ENG_RO_USERNAME" --password-stdin \<<<"$QUAY_RHACS_ENG_RO_PASSWORD" quay.io

      - run:
          name: Check build output using the built image
          command: |
            TAG="$(.circleci/get_tag.sh "env-check")"
            export IMAGE="quay.io/rhacs-eng/apollo-ci:${TAG}"
            export CIRCLECI_TOKEN="$CIRCLE_TOKEN_ROXBOT"
            docker pull "$IMAGE"

            docker run --rm \
              -e CIRCLECI_TOKEN -e CIRCLE_WORKFLOW_ID \
              -e CIRCLE_PROJECT_REPONAME -e CIRCLE_BUILD_NUM \
              "$IMAGE" poll-for-workflow-completion.js 1800

            scratch="$(mktemp -d)"
            output_dir="$scratch/builds"
            mkdir -p "$output_dir"
            docker run -u "$(id -u):$(id -g)" --rm \
              -e CIRCLECI_TOKEN -e CIRCLE_WORKFLOW_ID \
              -e CIRCLE_PROJECT_REPONAME -e CIRCLE_BUILD_NUM \
              -v "$scratch":"$scratch":z \
              "$IMAGE" pull-workflow-output.js "$output_dir"

            env_file="$scratch/check.env"
            env > "$env_file"
            docker run -u "$(id -u):$(id -g)" --rm \
              -v "$scratch":"$scratch":z \
              "$IMAGE" check-for-sensitive-env-values.js -e "$env_file" -b "$output_dir"
            rm "$env_file"

  build-and-push-collector:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/collector.Dockerfile
          image-flavor: "collector"
      - check-image:
          image-flavor: "collector"

  build-and-push-jenkins-plugin:
    <<: *defaults
    steps:
      - build-and-push-image:
          dockerfile-path: images/jenkins-plugin.Dockerfile
          image-flavor: "jenkins-plugin"
      - check-image:
          image-flavor: "jenkins-plugin"

  create-or-update-stackrox-repo-pr:
    <<: *defaults
    steps:
      - open-test-pr:
          repo: stackrox
          image-flavors: "stackrox-build,rox"
  create-or-update-scanner-repo-pr:
    <<: *defaults
    steps:
      - open-test-pr:
          repo: scanner
          image-flavors: "rox"
  create-or-update-collector-repo-pr:
    <<: *defaults
    steps:
      - open-test-pr:
          repo: collector
          image-flavors: "collector"
  create-or-update-jenkins-plugin-repo-pr:
    <<: *defaults
    steps:
      - open-test-pr:
          repo: jenkins-plugin
          image-flavors: "jenkins-plugin"

workflows:
  version: 2
  build:
    jobs:
    - bats/run:
        path: ./test/bats
        filters:
          tags:
            only: /.*/
    - build-and-push-rocksdb:
        context:
          - quay-rhacs-eng-readwrite
          - docker-io-pull
        filters:
          tags:
            only: /.*/
    - build-and-push-centos8-rocksdb:
        context:
          - quay-rhacs-eng-readwrite
          - docker-io-pull
        filters:
          tags:
            only: /.*/
    - build-and-push-base:
        context:
          - quay-rhacs-eng-readwrite
          - docker-io-pull
        filters:
          tags:
            only: /.*/
    - test-cci-export:
        context: quay-rhacs-eng-readonly
        filters:
          tags:
            only: /.*/
        requires:
        - build-and-push-base
        - bats/run
    - build-and-push-rox:
        context:
          - quay-rhacs-eng-readwrite
          - stackrox-ci-instance
          - docker-io-pull
        filters:
          tags:
            only: /.*/
        requires:
        - build-and-push-base
        - build-and-push-rocksdb
        - test-cci-export
    - build-and-push-stackrox-build:
        context:
          - quay-rhacs-eng-readwrite
          - stackrox-ci-instance
        filters:
          tags:
            only: /.*/
        requires:
        - build-and-push-centos8-rocksdb
    - build-and-push-env-check:
        context:
          - quay-rhacs-eng-readwrite
          - stackrox-ci-instance
          - docker-io-pull
        filters:
          tags:
            only: /.*/
        requires:
        - bats/run
    - unit-test-env-check:
        context: quay-rhacs-eng-readonly
        requires:
        - build-and-push-env-check
    - check-env-for-sensitive-values:
        context:
          - quay-rhacs-eng-readonly
          - quay-rhacs-eng-readwrite
        requires:
        - unit-test-env-check
        - build-and-push-rox
    - build-and-push-collector:
        context:
          - quay-rhacs-eng-readwrite
          - stackrox-ci-instance
          - docker-io-pull
        filters:
          tags:
            only: /.*/
        requires:
        - bats/run
    - build-and-push-jenkins-plugin:
        context:
          - quay-rhacs-eng-readwrite
          - stackrox-ci-instance
          - docker-io-pull
        filters:
          tags:
            only: /.*/
        requires:
        - bats/run
    - create-or-update-collector-repo-pr:
        filters:
          branches:
            ignore: master
        requires:
        - build-and-push-collector
    - create-or-update-stackrox-repo-pr:
        filters:
          branches:
            ignore: master
        requires:
        - build-and-push-rox
        - build-and-push-stackrox-build
    - create-or-update-scanner-repo-pr:
        filters:
          branches:
            ignore: master
        requires:
        - build-and-push-rox
    - create-or-update-jenkins-plugin-repo-pr:
        filters:
          branches:
            ignore: master
        requires:
        - build-and-push-jenkins-plugin
